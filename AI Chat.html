<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wechnology AI Chat Simulator</title>
    <link rel="icon" type="image/x-icon" href="Wechnology-W-(white bg).png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles for Mobile Wireframe Look */
        body {
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            font-family: 'Inter', sans-serif;
        }
        #mobile-frame {
            width: 100%;
            max-width: 400px; /* Standard mobile width */
            background: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: 2rem;
            overflow: hidden;
            min-height: 600px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .ai-message {
            background-color: #e0f7fa; /* Light cyan for AI (Wechnology Green-Blue tint) */
            border-radius: 1.25rem 1.25rem 1.25rem 0.5rem;
        }
        .user-message {
            background-color: #0f31ad; /* Wechnology Blue */
            color: white;
            border-radius: 1.25rem 1.25rem 0.5rem 1.25rem;
            align-self: flex-end;
        }
        .card-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .card-option:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 25px rgba(15, 49, 173, 0.2);
        }
        .input-bar {
            border-top: 1px solid #eee;
            padding: 1rem;
            background: white;
        }
        .loading-dot {
            width: 8px;
            height: 8px;
            background-color: #00a859;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body>

    <div id="mobile-frame">
        <!-- Header -->
        <div class="p-4 bg-gradient-to-r from-blue-800 to-green-500 text-white shadow-lg flex items-center justify-between sticky top-0 z-10">
            <h1 class="text-xl font-bold font-serif">Wechnology AI</h1>
            <div id="status-dot" class="w-3 h-3 bg-green-400 rounded-full animate-pulse shadow-xl"></div>
        </div>

        <!-- Content Area -->
        <div id="content" class="flex-grow p-4 overflow-y-auto space-y-4">
            <!-- Initial Gender Selection Screen -->
            <div id="gender-selection" class="flex flex-col items-center justify-center h-full min-h-[500px] p-8 space-y-6 text-center">
                <p class="text-lg font-semibold text-gray-700 mb-6">Welcome! To start your personalized experience, please choose your gender:</p>
                <div class="flex space-x-4 w-full">
                    <div id="male-card" class="card-option flex-1 p-6 bg-white border-2 border-blue-800 text-blue-800 rounded-2xl shadow-md flex flex-col items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                        <span class="font-bold">Male</span>
                    </div>
                    <div id="female-card" class="card-option flex-1 p-6 bg-white border-2 border-pink-500 text-pink-500 rounded-2xl shadow-md flex flex-col items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                        <span class="font-bold">Female</span>
                    </div>
                </div>
            </div>

            <!-- Chat Container (Hidden initially) -->
            <div id="chat-box" class="flex flex-col space-y-4 hidden">
                <!-- Messages will be appended here -->
            </div>
        </div>

        <!-- Input Area (Hidden initially) -->
        <div id="input-area" class="input-bar hidden">
            <!-- Dynamic input/buttons based on chat state -->
        </div>

        <!-- Audio Player (Hidden) -->
        <audio id="audio-player" class="hidden"></audio>

        <!-- Loading Indicator (Hidden) -->
        <div id="loading-indicator" class="hidden absolute inset-0 bg-white bg-opacity-70 flex items-center justify-center">
            <div class="text-center p-4 rounded-xl shadow-xl bg-gray-100">
                <p class="text-gray-700 font-semibold mb-2">Taiwo is speaking...</p>
                <div>
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                    <span class="loading-dot"></span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Initialization (MANDATORY boilerplate)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = 'anon_user'; // Will be updated on successful auth

        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Auth Listener
            (async () => {
                try {
                    if (initialAuthToken) {
                        const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                        userId = userCredential.user.uid;
                    } else {
                        const userCredential = await signInAnonymously(auth);
                        userId = userCredential.user.uid;
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    // Fallback to anonymous ID if auth fails
                    userId = crypto.randomUUID();
                }
            })();
        } else {
            console.warn("Firebase configuration not found. Running in simulation mode.");
        }


        // --- Core UI Elements & State ---
        const contentDiv = document.getElementById('content');
        const chatBox = document.getElementById('chat-box');
        const inputArea = document.getElementById('input-area');
        const loadingIndicator = document.getElementById('loading-indicator');
        const audioPlayer = document.getElementById('audio-player');
        const apiKey = ""; // API Key placeholder for Gemini

        let chatState = 0; // 0: Gender, 1: Naming, 2: Chatting
        const AI_NAME = 'Taiwo';
        const USER_NAME = 'Madam Cynthia';
        const AI_VOICE = 'Leda'; // Friendly, youthful voice for the AI

        // --- Utility Functions for TTS (PCM to WAV) ---

        const base64ToArrayBuffer = (base64) => {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        const pcmToWav = (pcmData, sampleRate) => {
            const numChannels = 1;
            const bitsPerSample = 16;
            const pcm16 = new Int16Array(pcmData);
            const pcmLength = pcm16.length;

            // WAV format header size (44 bytes)
            const buffer = new ArrayBuffer(44 + pcmLength * 2);
            const view = new DataView(buffer);
            let offset = 0;

            const writeString = (s) => {
                for (let i = 0; i < s.length; i++) {
                    view.setUint8(offset + i, s.charCodeAt(i));
                }
                offset += s.length;
            };

            // RIFF chunk
            writeString('RIFF');
            view.setUint32(offset, 36 + pcmLength * 2, true); offset += 4; // ChunkSize
            writeString('WAVE');

            // FMT chunk
            writeString('fmt ');
            view.setUint32(offset, 16, true); offset += 4; // Subchunk1Size
            view.setUint16(offset, 1, true); offset += 2; // AudioFormat (1=PCM)
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, sampleRate * numChannels * (bitsPerSample / 8), true); offset += 4; // ByteRate
            view.setUint16(offset, numChannels * (bitsPerSample / 8), true); offset += 2; // BlockAlign
            view.setUint16(offset, bitsPerSample, true); offset += 2;

            // DATA chunk
            writeString('data');
            view.setUint32(offset, pcmLength * 2, true); offset += 4; // Subchunk2Size

            // PCM data
            for (let i = 0; i < pcmLength; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([buffer], { type: 'audio/wav' });
        };

        // --- API Call Function (with Exponential Backoff) ---

        const generateAndPlaySpeech = async (text, role, voiceName = AI_VOICE) => {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [{ text: text }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voiceName }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            loadingIndicator.classList.remove('hidden');

            const makeRequest = async (attempt) => {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < 5) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            return new Promise(resolve => setTimeout(() => resolve(makeRequest(attempt + 1)), delay));
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000; // Default sample rate
                        const pcmData = base64ToArrayBuffer(audioData);

                        // The API returns raw signed PCM16 audio data.
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);

                        return new Promise((resolve) => {
                            audioPlayer.src = audioUrl;
                            audioPlayer.onended = () => {
                                URL.revokeObjectURL(audioUrl);
                                loadingIndicator.classList.add('hidden');
                                resolve();
                            };
                            audioPlayer.play().catch(e => {
                                console.error("Audio playback failed:", e);
                                loadingIndicator.classList.add('hidden');
                                resolve(); // Resolve even on play failure to continue chat
                            });
                        });

                    } else {
                        console.error("No valid audio data received from API.");
                        loadingIndicator.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("API or Network Error:", error);
                    loadingIndicator.classList.add('hidden');
                }
            };

            await makeRequest(1);
        };

        // --- Chat UI & Logic ---

        const appendMessage = (text, role) => {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${role === 'ai' ? 'justify-start' : 'justify-end'} `;
            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-[75%] p-3 text-sm shadow-md ${role === 'ai' ? 'ai-message text-gray-800' : 'user-message'}`;
            messageBubble.textContent = text;
            messageWrapper.appendChild(messageBubble);
            chatBox.appendChild(messageWrapper);
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        const handleNameInput = () => {
            inputArea.innerHTML = `
                <div class="flex space-x-2">
                    <input type="text" id="name-input" placeholder="Type AI's name (e.g., Taiwo)" class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500" value="Taiwo">
                    <button id="send-name" class="px-4 py-3 bg-green-500 text-white font-bold rounded-xl hover:bg-green-600 transition duration-150">Send</button>
                </div>
            `;

            document.getElementById('send-name').onclick = async () => {
                const nameInput = document.getElementById('name-input').value.trim() || 'Taiwo';
                const userName = USER_NAME; // Madam Cynthia

                // 1. User Message: Taiwo
                appendMessage(nameInput, 'user');
                inputArea.innerHTML = '';

                // 2. AI Response: I tank you welu welu.
                const aiResponse2Text = "I tank you welu welu.";
                appendMessage(AI_NAME + ': ' + aiResponse2Text, 'ai');
                await generateAndPlaySpeech(aiResponse2Text, 'ai');

                chatState = 2; // Move to main chat
                await startMainConversation(userName);
            };
        };

        const startMainConversation = async (userName) => {
            // 3. AI Welcome: Welcome Madamu! I be Taiwo, your Wechnology AI. How I fit help you manage your business today, Madamu?
            const welcomeText = `Welcome Madamu! I be ${AI_NAME}, your Wechnology AI. How I fit help you manage your business today, Madamu?`;
            appendMessage(AI_NAME + ': ' + welcomeText, 'ai');
            await generateAndPlaySpeech(welcomeText, 'ai');

            // 4. Input Area: Prompt user with the pre-written question
            inputArea.innerHTML = `
                <div class="p-4 bg-gray-100 rounded-xl shadow-inner">
                    <p class="text-sm font-semibold text-gray-700 mb-2">Simulate User Question:</p>
                    <button id="question-button" class="w-full text-left p-3 bg-white border border-blue-500 text-blue-800 font-medium rounded-xl hover:bg-blue-50 transition duration-150">
                        Taiwo, wetin be my profit for last month
                    </button>
                </div>
            `;

            document.getElementById('question-button').onclick = async () => {
                const userQuestion = document.getElementById('question-button').textContent.trim();
                inputArea.innerHTML = ''; // Clear input area while AI responds

                // 5. User Message: Taiwo, wetin be my profit for last month
                appendMessage(userQuestion, 'user');

                // 6. AI Response: Madamu, profit wey you make last month na N50,000. Shey you bin get anoda question, Madam Cynthia?
                const finalResponse = `Madamu, profit wey you make last month na N50,000. Shey you bin get anoda question, ${userName}?`;
                appendMessage(AI_NAME + ': ' + finalResponse, 'ai');
                await generateAndPlaySpeech(finalResponse, 'ai');

                // Final state - show a generic chat input
                inputArea.innerHTML = `
                    <div class="flex space-x-2">
                        <input type="text" placeholder="Type your next question..." class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-green-500 focus:border-green-500">
                        <button class="px-4 py-3 bg-gray-400 text-white font-bold rounded-xl">Send</button>
                    </div>
                `;
            };
        };


        // --- State Transitions ---

        const handleGenderSelection = async (gender) => {
            if (gender === 'Male') {
                // Not the requested path, but still provide feedback
                alert('Wechnology is developing a specialized male persona. Please select Female for this demonstration.');
                return;
            }

            // 1. Hide gender selection, show chat box
            document.getElementById('gender-selection').classList.add('hidden');
            chatBox.classList.remove('hidden');
            inputArea.classList.remove('hidden');

            chatState = 1; // Move to Naming stage

            // 2. AI Response: I salute you, Madam Cynthia. So wetin you go dey call me like this, Madam?
            const aiResponse1Text = `I salute you, ${USER_NAME}. So wetin you go dey call me like this, Madam?`;
            appendMessage('AI: ' + aiResponse1Text, 'ai');
            await generateAndPlaySpeech(aiResponse1Text, 'ai');

            // 3. Prompt for name input
            handleNameInput();
        };

        // Event Listeners for Gender Selection
        document.getElementById('male-card').addEventListener('click', () => handleGenderSelection('Male'));
        document.getElementById('female-card').addEventListener('click', () => handleGenderSelection('Female'));

        // Initial setup to scroll to the bottom if chat starts immediately
        document.addEventListener('DOMContentLoaded', () => {
             chatBox.scrollTop = chatBox.scrollHeight;
        });

    </script>
</body>
</html>
